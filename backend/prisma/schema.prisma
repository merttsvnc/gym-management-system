// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// Role enum
enum Role {
  ADMIN
  // Future: OWNER, STAFF, TRAINER, ACCOUNTANT
}

// Plan enum
enum PlanKey {
  SINGLE
}

// Member status enum
enum MemberStatus {
  ACTIVE
  PAUSED
  INACTIVE
  ARCHIVED
}

// Member gender enum
enum MemberGender {
  MALE
  FEMALE
}

// Duration type enum for membership plans
enum DurationType {
  DAYS
  MONTHS
}

// Plan status enum
enum PlanStatus {
  ACTIVE
  ARCHIVED
}

// Plan scope enum
enum PlanScope {
  TENANT
  BRANCH
}

// Billing status enum
enum BillingStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  SUSPENDED
}

// Payment method enum
enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  OTHER
}

// Tenant model
model Tenant {
  id                     String        @id @default(cuid())
  name                   String
  slug                   String        @unique
  defaultCurrency        String        @default("USD")
  planKey                PlanKey       @default(SINGLE)
  billingStatus          BillingStatus @default(TRIAL)
  billingStatusUpdatedAt DateTime?
  trialStartedAt        DateTime?
  trialEndsAt           DateTime?
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // Relations
  branches        Branch[]
  users           User[]
  members         Member[]
  membershipPlans MembershipPlan[]
  payments        Payment[]

  @@index([slug])
  @@index([billingStatus])
}

// Branch model
model Branch {
  id         String    @id @default(cuid())
  tenantId   String
  name       String
  address    String
  isDefault  Boolean   @default(false)
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  archivedAt DateTime?

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members         Member[]
  membershipPlans MembershipPlan[]
  payments        Payment[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, isDefault])
}

// User model
model User {
  id           String   @id @default(cuid())
  tenantId     String
  email        String   @unique
  passwordHash String
  firstName    String
  lastName     String
  role         Role     @default(ADMIN)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([email])
}

// MembershipPlan model
model MembershipPlan {
  id            String       @id @default(cuid())
  tenantId      String
  scope         PlanScope    @default(TENANT)
  branchId      String?
  scopeKey      String       @default("TENANT")
  name          String
  description   String?
  durationType  DurationType
  durationValue Int
  price         Decimal      @db.Decimal(10, 2)
  currency      String
  maxFreezeDays Int?
  autoRenew     Boolean      @default(false)
  status        PlanStatus
  archivedAt    DateTime?
  sortOrder     Int?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch  Branch?  @relation(fields: [branchId], references: [id], onDelete: Restrict)
  members Member[]

  @@unique([tenantId, scope, scopeKey, name])
  @@index([tenantId])
  @@index([tenantId, scope])
  @@index([tenantId, status])
  @@index([tenantId, scope, status])
  @@index([tenantId, branchId])
  @@index([branchId])
  @@index([tenantId, sortOrder])
  @@index([tenantId, archivedAt])
  @@index([tenantId, archivedAt, status])
}

// Member model
model Member {
  id       String @id @default(cuid())
  tenantId String
  branchId String

  // Core profile fields
  firstName   String
  lastName    String
  gender      MemberGender?
  dateOfBirth DateTime?
  phone       String
  email       String?
  photoUrl    String?

  // Membership information
  membershipPlanId          String
  membershipStartDate       DateTime
  membershipEndDate         DateTime
  membershipPriceAtPurchase Decimal? @db.Decimal(10, 2)

  // Status
  status    MemberStatus @default(ACTIVE)
  pausedAt  DateTime?
  resumedAt DateTime?

  // Notes
  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch         Branch         @relation(fields: [branchId], references: [id], onDelete: Restrict)
  membershipPlan MembershipPlan @relation(fields: [membershipPlanId], references: [id])
  payments       Payment[]

  @@index([tenantId, branchId])
  @@index([tenantId, phone])
  @@index([membershipPlanId])
  @@index([tenantId, membershipPlanId])
}

// Payment model
// AUDIT TRAIL DESIGN:
// - Original payments can have MULTIPLE corrections (no unique constraint on correctedPaymentId)
// - Each correction points to the original via correctedPaymentId
// - Original payment's isCorrected flag tracks "has been corrected at least once"
// - To find all corrections for payment A: query where correctedPaymentId = A.id
// - Revenue reports exclude corrections by filtering: isCorrection = false
model Payment {
  id                 String        @id @default(cuid())
  tenantId           String
  branchId           String
  memberId           String

  // Payment details
  amount             Decimal       @db.Decimal(10, 2)
  paidOn             DateTime      // DATE-ONLY business date: stored as DateTime set to start-of-day UTC (00:00:00Z); tenant timezone used for date selection/display
  paymentMethod      PaymentMethod
  note               String?       @db.VarChar(500)

  // Correction tracking (audit trail: multiple corrections allowed per original payment)
  isCorrection       Boolean       @default(false)
  correctedPaymentId String?       // FK to original payment being corrected (no @unique = many corrections per original)
  isCorrected        Boolean       @default(false)

  // Optimistic locking
  version            Int           @default(0)

  // Audit fields (strictly for audit, not business logic)
  createdBy          String        // User ID
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  tenant             Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch             Branch        @relation(fields: [branchId], references: [id], onDelete: Restrict)
  member             Member        @relation(fields: [memberId], references: [id], onDelete: Restrict)
  correctedPayment   Payment?      @relation("PaymentCorrection", fields: [correctedPaymentId], references: [id], onDelete: SetNull)
  correctingPayments Payment[]     @relation("PaymentCorrection")  // One-to-many: original payment can have multiple corrections

  @@index([tenantId])
  @@index([tenantId, branchId])
  @@index([tenantId, memberId])
  @@index([tenantId, paidOn])
  @@index([tenantId, paymentMethod])
  @@index([tenantId, paidOn, branchId])
  @@index([tenantId, paidOn, paymentMethod])
  @@index([memberId])
  @@index([branchId])
  @@index([correctedPaymentId])
  @@index([tenantId, isCorrection])
  @@index([tenantId, isCorrected])
}

// IdempotencyKey model (for idempotency support)
model IdempotencyKey {
  id           String    @id @default(cuid())
  key          String    @unique
  tenantId     String
  userId       String
  response     Json      // Cached response
  createdAt    DateTime  @default(now())
  expiresAt    DateTime  // TTL: 24 hours

  @@index([key])
  @@index([expiresAt]) // For cleanup job
}
